<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Firebase Control</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
        }
        .status-dot {
            transition: background-color 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div class="container mx-auto p-4 md:p-8 max-w-lg">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white">ESP32 Control Panel</h1>
            <p class="text-gray-600 dark:text-gray-400 mt-2">Real-time device control via Firebase</p>
        </header>

        <main id="controls-container" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 space-y-4">
            <!-- Loading state -->
            <div id="loading-state" class="text-center text-gray-500 dark:text-gray-400">
                <p>Connecting to Firebase and fetching devices...</p>
            </div>
            <!-- Buttons will be dynamically inserted here -->
        </main>

        <footer class="text-center mt-8 text-sm text-gray-500 dark:text-gray-400">
            <p>Connection Status: <span id="connection-status" class="font-semibold text-red-500">Disconnected</span></p>
        </footer>
    </div>

    <!-- Firebase SDKs -->
    <!-- You MUST use version 8.x.x for the legacy `firebase.database()` syntax -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // --- Firebase Configuration ---
        // IMPORTANT: Replace with your actual Firebase project configuration.
        const firebaseConfig = {
            apiKey: "AIzaSyBxwM04W_3vHbXbNb7cvEXWUi3udRVXFXk",
            authDomain: "pico-iot-v1-2-9cf83.firebaseapp.com",
            databaseURL: "https://pico-iot-v1-2-9cf83-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "pico-iot-v1-2-9cf83",
            storageBucket: "pico-iot-v1-2-9cf83.firebasestorage.app",
            messagingSenderId: "638387216051",
            appId: "1:638387216051:web:815f11565cd7324a829ac6",
            measurementId: "G-J3XRZBP0YK"
        };

        // --- Initialize Firebase ---
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- DOM Elements ---
        const controlsContainer = document.getElementById('controls-container');
        const loadingState = document.getElementById('loading-state');
        const connectionStatusEl = document.getElementById('connection-status');

        // --- Firebase Database Path ---
        // As seen in your screenshot, this path points to the Nodes.
        const deviceId = "PICO-IOT:40:F5:20:3F:37:B0";
        const nodesRef = database.ref(`devices/${deviceId}/Nodes`);

        // --- Real-time Connection Status ---
        const connectedRef = database.ref(".info/connected");
        connectedRef.on("value", (snap) => {
            if (snap.val() === true) {
                connectionStatusEl.textContent = "Connected";
                connectionStatusEl.classList.remove('text-red-500');
                connectionStatusEl.classList.add('text-green-500');
            } else {
                connectionStatusEl.textContent = "Disconnected";
                connectionStatusEl.classList.remove('text-green-500');
                connectionStatusEl.classList.add('text-red-500');
            }
        });


        // --- Listen for Data Changes ---
        nodesRef.on('value', (snapshot) => {
            // Clear previous controls
            controlsContainer.innerHTML = '';

            const nodes = snapshot.val();

            if (!nodes) {
                controlsContainer.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400">No nodes found for this device.</p>';
                return;
            }
            
            // Hide loading state once data is loaded
            if(loadingState) loadingState.style.display = 'none';

            // Create a button for each node
            for (const nodeKey in nodes) {
                const nodeData = nodes[nodeKey];
                const isOn = nodeData.isOn;
                const isOnFB = nodeData.isOnFB; // Feedback from ESP32

                // Create the button element
                const buttonWrapper = document.createElement('div');
                buttonWrapper.className = "flex items-center justify-between bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-sm";
                
                const buttonLabel = document.createElement('span');
                buttonLabel.className = "text-lg font-medium text-gray-800 dark:text-gray-200";
                buttonLabel.textContent = nodeKey;

                const rightSideWrapper = document.createElement('div');
                rightSideWrapper.className = "flex items-center space-x-4";

                const feedbackIndicator = document.createElement('div');
                feedbackIndicator.className = "flex items-center space-x-2";
                const feedbackDot = document.createElement('div');
                feedbackDot.className = `status-dot w-4 h-4 rounded-full ${isOnFB ? 'bg-green-500' : 'bg-red-500'}`;
                const feedbackText = document.createElement('span');
                feedbackText.className = "text-sm text-gray-500 dark:text-gray-400";
                feedbackText.textContent = `Feedback: ${isOnFB ? 'ON' : 'OFF'}`;
                feedbackIndicator.appendChild(feedbackDot);
                feedbackIndicator.appendChild(feedbackText);


                const toggleButton = document.createElement('button');
                toggleButton.textContent = isOn ? 'Turn OFF' : 'Turn ON';
                toggleButton.className = `px-4 py-2 rounded-md font-semibold text-white shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-transform transform hover:scale-105 ${
                    isOn ? 'bg-red-600 hover:bg-red-700 focus:ring-red-500' : 'bg-indigo-600 hover:bg-indigo-700 focus:ring-indigo-500'
                }`;

                // --- Click Event Handler ---
                toggleButton.addEventListener('click', () => {
                    // When the button is clicked, update the 'isOn' value in Firebase.
                    const nodeToUpdateRef = nodesRef.child(nodeKey);
                    // Set the value to the opposite of the current state
                    nodeToUpdateRef.child('isOn').set(!isOn)
                        .catch(error => console.error("Error updating data: ", error));
                });

                // Assemble the elements
                rightSideWrapper.appendChild(feedbackIndicator);
                rightSideWrapper.appendChild(toggleButton);
                buttonWrapper.appendChild(buttonLabel);
                buttonWrapper.appendChild(rightSideWrapper);
                controlsContainer.appendChild(buttonWrapper);
            }
        }, (error) => {
            console.error("Firebase read failed: " + error.code);
            controlsContainer.innerHTML = `<p class="text-center text-red-500">Error: Could not connect to the database. Check console for details.</p>`;
        });

    </script>
</body>
</html>
