<!DOCTYPE html>
<html lang="en" class="dark"> <!-- Set dark mode as default -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Control Panel - Dark Theme</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for a polished dark look */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Main dark background */
            color: #d1d5db; /* Default light gray text */
        }
        .status-dot {
            transition: background-color 0.3s ease-in-out;
        }
        .device-card {
            transition: box-shadow 0.3s ease; /* Removed transform transition */
            background-color: #1f2937; /* Slightly lighter card background */
        }
        /* Removed the :hover pseudo-class that caused the animation */
    </style>
</head>
<body>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white">IoT Control Panel</h1>
            <p class="text-gray-400 mt-2">Dynamically discovers and controls all your devices.</p>
        </header>

        <main id="devices-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Loading state -->
            <div id="loading-state" class="md:col-span-2 text-center text-gray-400 bg-gray-800 rounded-xl shadow-md p-8">
                <svg class="animate-spin h-8 w-8 text-indigo-400 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="font-semibold">Connecting to Firebase and discovering devices...</p>
            </div>
            <!-- Device cards will be dynamically inserted here -->
        </main>

        <footer class="text-center mt-10 text-sm text-gray-500">
            <p>Firebase Status: <span id="connection-status" class="font-semibold text-red-500">Disconnected</span></p>
        </footer>
    </div>

    <!-- Firebase SDKs (v8 for legacy database syntax) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBxwM04W_3vHbXbNb7cvEXWUi3udRVXFXk",
            authDomain: "pico-iot-v1-2-9cf83.firebaseapp.com",
            databaseURL: "https://pico-iot-v1-2-9cf83-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "pico-iot-v1-2-9cf83",
            storageBucket: "pico-iot-v1-2-9cf83.firebasestorage.app",
            messagingSenderId: "638387216051",
            appId: "1:638387216051:web:815f11565cd7324a829ac6",
            measurementId: "G-J3XRZBP0YK"
        };

        // --- Initialize Firebase ---
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- DOM Elements ---
        const devicesContainer = document.getElementById('devices-container');
        const loadingState = document.getElementById('loading-state');
        const connectionStatusEl = document.getElementById('connection-status');

        // --- Top-level Firebase Reference ---
        const devicesRef = database.ref('devices');

        // --- Real-time Connection Status ---
        database.ref(".info/connected").on("value", (snap) => {
            if (snap.val() === true) {
                connectionStatusEl.textContent = "Connected";
                connectionStatusEl.classList.remove('text-red-500');
                connectionStatusEl.classList.add('text-green-500');
            } else {
                connectionStatusEl.textContent = "Disconnected";
                connectionStatusEl.classList.remove('text-green-500');
                connectionStatusEl.classList.add('text-red-500');
            }
        });

        // --- Main listener for all devices ---
        devicesRef.on('value', (snapshot) => {
            devicesContainer.innerHTML = '';
            const devices = snapshot.val();

            if (!devices) {
                loadingState.innerHTML = '<p class="font-semibold">No devices found in the database.</p><p>Add a device to get started.</p>';
                devicesContainer.appendChild(loadingState);
                return;
            }

            for (const deviceId in devices) {
                const deviceData = devices[deviceId];
                createDeviceCard(deviceId, deviceData);
            }
        }, (error) => {
            console.error("Firebase read failed: ", error);
            loadingState.innerHTML = `<p class="font-semibold text-red-500">Error connecting to database.</p><p>Please check the console for details.</p>`;
            devicesContainer.appendChild(loadingState);
        });

        /**
         * Creates and appends a device card to the main container.
         * @param {string} deviceId - The unique ID of the device.
         * @param {object} deviceData - The data object for the device.
         */
        function createDeviceCard(deviceId, deviceData) {
            const card = document.createElement('div');
            card.className = 'device-card rounded-xl shadow-md p-5 flex flex-col space-y-4';

            const deviceName = deviceData.name || deviceId;
            const isOnline = deviceData.isOnline;
            const header = document.createElement('div');
            header.className = 'flex justify-between items-center border-b border-gray-700 pb-3';
            header.innerHTML = `
                <div>
                    <h2 class="text-xl font-bold text-white">${deviceName}</h2>
                    <p class="text-xs text-gray-500 font-mono">${deviceId}</p>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="status-dot w-3 h-3 rounded-full ${isOnline ? 'bg-green-500' : 'bg-gray-500'}"></div>
                    <span class="text-sm font-medium ${isOnline ? 'text-green-400' : 'text-gray-500'}">
                        ${isOnline ? 'Online' : 'Offline'}
                    </span>
                </div>
            `;
            card.appendChild(header);

            const nodesContainer = document.createElement('div');
            nodesContainer.className = 'space-y-3 pt-2';
            
            const nodes = deviceData.Nodes;
            if (nodes) {
                for (const nodeKey in nodes) {
                    const nodeData = nodes[nodeKey];
                    const nodeElement = createNodeControl(deviceId, nodeKey, nodeData);
                    nodesContainer.appendChild(nodeElement);
                }
            } else {
                nodesContainer.innerHTML = '<p class="text-sm text-center text-gray-400 py-4">No controllable nodes found.</p>';
            }
            
            card.appendChild(nodesContainer);
            devicesContainer.appendChild(card);
        }

        /**
         * Creates a single control row for a node.
         * @param {string} deviceId - The ID of the parent device.
         * @param {string} nodeKey - The key/name of the node.
         * @param {object} nodeData - The data object for the node.
         * @returns {HTMLElement} The fully constructed node control element.
         */
        function createNodeControl(deviceId, nodeKey, nodeData) {
            const isOn = nodeData.isOn;
            const isOnFB = nodeData.isOnFB;

            const wrapper = document.createElement('div');
            wrapper.className = 'flex items-center justify-between bg-gray-700/50 p-3 rounded-lg';

            const label = document.createElement('span');
            label.className = 'text-md font-medium text-gray-200';
            label.textContent = nodeKey;

            const controls = document.createElement('div');
            controls.className = 'flex items-center space-x-4';

            const feedbackIndicator = document.createElement('div');
            feedbackIndicator.className = 'flex items-center space-x-2 text-xs text-gray-400';
            feedbackIndicator.innerHTML = `
                <div class="status-dot w-2.5 h-2.5 rounded-full ${isOnFB ? 'bg-green-500' : 'bg-red-500'}"></div>
                <span>FB: ${isOnFB ? 'ON' : 'OFF'}</span>
            `;

            const toggleButton = document.createElement('button');
            toggleButton.textContent = isOn ? 'OFF' : 'ON';
            toggleButton.className = `w-16 py-1.5 rounded-md font-semibold text-white text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 transition-all transform hover:scale-105 ${
                isOn ? 'bg-red-600 hover:bg-red-700 focus:ring-red-500' : 'bg-indigo-600 hover:bg-indigo-700 focus:ring-indigo-500'
            }`;

            toggleButton.addEventListener('click', () => {
                const nodeRef = database.ref(`devices/${deviceId}/Nodes/${nodeKey}/isOn`);
                nodeRef.set(!isOn).catch(error => console.error("Error updating node state: ", error));
            });
            
            controls.appendChild(feedbackIndicator);
            controls.appendChild(toggleButton);
            wrapper.appendChild(label);
            wrapper.appendChild(controls);

            return wrapper;
        }

    </script>
</body>
</html>
